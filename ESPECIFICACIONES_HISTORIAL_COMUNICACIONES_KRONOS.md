# ESPECIFICACIONES T√âCNICAS: HISTORIAL DE COMUNICACIONES ENTRE N√öMEROS
# KRONOS - An√°lisis Forense de Comunicaciones

**Fecha:** 2025-08-21  
**Desarrollador:** Boris  
**Contexto:** Funcionalidad activada desde diagrama de correlaci√≥n React Flow  

---

## üìä AN√ÅLISIS DE INFRAESTRUCTURA EXISTENTE

### ‚úÖ **ESTRUCTURA DE DATOS YA DISPONIBLE**

La base de datos `kronos.db` ya contiene toda la informaci√≥n necesaria:

- **3,392 registros** en `operator_call_data` con historial completo
- **Correlaci√≥n autom√°tica** con datos HUNTER en `cellular_data`  
- **15+ √≠ndices especializados** para consultas optimizadas
- **Funci√≥n Eel operativa:** `get_call_interactions` con l√≥gica bidireccional

### üéØ **OBJETIVO DEL DESARROLLO**

Crear funciones especializadas para el frontend React que permitan:

1. **Historial bidireccional** entre n√∫meros espec√≠ficos desde el diagrama
2. **An√°lisis temporal** de patrones de comunicaci√≥n
3. **Correlaci√≥n geogr√°fica** con datos HUNTER reales
4. **Estad√≠sticas forenses** para investigadores

---

## üîß ARQUITECTURA PROPUESTA

### **1. NUEVAS FUNCIONES EEL ESPECIALIZADAS**

#### **A) `get_communication_history` - Funci√≥n Principal**

```python
@eel.expose
def get_communication_history(mission_id: str, number_a: str, number_b: str, 
                            date_range: dict = None, filters: dict = None) -> dict:
```

**Prop√≥sito:** Obtener historial completo entre dos n√∫meros espec√≠ficos  
**Optimizaci√≥n:** Query bidireccional con UNION para m√°ximo rendimiento  
**Salida:** Timeline completo con estad√≠sticas y correlaci√≥n HUNTER  

**Query SQL Optimizada:**
```sql
-- Consulta bidireccional eficiente usando UNION
SELECT * FROM (
    -- Llamadas A ‚Üí B
    SELECT numero_origen as caller, numero_destino as receiver, 'A_TO_B' as direction,
           fecha_hora_llamada, duracion_segundos, operator, celda_origen, celda_destino,
           cd_origen.punto as origin_hunter, cd_destino.punto as dest_hunter
    FROM operator_call_data ocd
    LEFT JOIN cellular_data cd_origen ON cd_origen.cell_id = ocd.celda_origen 
    LEFT JOIN cellular_data cd_destino ON cd_destino.cell_id = ocd.celda_destino
    WHERE mission_id = ? AND numero_origen = ? AND numero_destino = ?
    
    UNION ALL
    
    -- Llamadas B ‚Üí A  
    SELECT numero_origen as caller, numero_destino as receiver, 'B_TO_A' as direction,
           fecha_hora_llamada, duracion_segundos, operator, celda_origen, celda_destino,
           cd_origen.punto as origin_hunter, cd_destino.punto as dest_hunter
    FROM operator_call_data ocd
    LEFT JOIN cellular_data cd_origen ON cd_origen.cell_id = ocd.celda_origen
    LEFT JOIN cellular_data cd_destino ON cd_destino.cell_id = ocd.celda_destino  
    WHERE mission_id = ? AND numero_origen = ? AND numero_destino = ?
)
ORDER BY fecha_hora_llamada DESC;
```

**Datos de Salida:**
```json
{
    "success": true,
    "total_calls": 47,
    "total_duration_minutes": 156.8,
    "date_range": {"first": "2021-05-20T08:15:22", "last": "2021-05-25T19:42:15"},
    "calls": [
        {
            "call_id": "operator_call_data:1234",
            "direction": "A_TO_B",
            "timestamp": "2021-05-20T10:02:26", 
            "duration_seconds": 91,
            "duration_formatted": "01:31",
            "operator": "CLARO",
            "call_type": "ENTRANTE",
            "call_status": "COMPLETADA",
            "technology": "LTE",
            "origin_cell": "20264",
            "destination_cell": "20264", 
            "cell_locations": {
                "origin": {"lat": 4.6482, "lon": -74.0648, "hunter_point": "HUNTER_001"},
                "destination": {"lat": 4.6482, "lon": -74.0648, "hunter_point": "HUNTER_001"}
            },
            "estimated_distance_km": 0.0,
            "location_precision": "ALTA"
        }
    ],
    "statistics": {
        "calls_by_direction": {"A_TO_B": 25, "B_TO_A": 22},
        "calls_by_operator": {"CLARO": 47, "MOVISTAR": 0},
        "calls_by_hour": {"08": 3, "10": 8, "14": 12, "18": 15, "20": 9},
        "average_duration_minutes": 3.34,
        "peak_activity_hour": "18:00",
        "unique_cells_used": 8
    },
    "timeline": [
        {
            "date": "2021-05-20",
            "total_calls": 15,
            "total_duration_minutes": 45.2,
            "first_call": "08:15:22",
            "last_call": "19:42:15"
        }
    ]
}
```

#### **B) `get_call_details` - Detalles T√©cnicos**

```python
@eel.expose  
def get_call_details(mission_id: str, call_id: str) -> dict:
```

**Prop√≥sito:** An√°lisis forense detallado de llamada espec√≠fica  
**Caracter√≠sticas:**
- Metadatos t√©cnicos completos
- Correlaci√≥n HUNTER precisa  
- Indicadores de patrones
- Contexto temporal (actividad relacionada)

#### **C) `get_related_communications` - An√°lisis Avanzado**

```python
@eel.expose
def get_related_communications(mission_id: str, number_a: str, number_b: str, 
                             analysis_type: str = "extended") -> dict:
```

**Prop√≥sito:** Detectar patrones y conexiones indirectas  
**An√°lisis incluidos:**
- Contactos comunes (intermediarios potenciales)
- Correlaciones temporales
- Celdas compartidas  
- Movimiento sincronizado

---

## üöÄ OPTIMIZACIONES DE RENDIMIENTO

### **NUEVOS √çNDICES ESPECIALIZADOS**

```sql
-- 1. HISTORIAL BIDIRECCIONAL OPTIMIZADO
CREATE INDEX idx_calls_bidirectional_history 
ON operator_call_data(mission_id, numero_origen, numero_destino, fecha_hora_llamada DESC);

-- 2. B√öSQUEDA INVERSA PARA EFICIENCIA
CREATE INDEX idx_calls_bidirectional_inverse 
ON operator_call_data(mission_id, numero_destino, numero_origen, fecha_hora_llamada DESC);

-- 3. AN√ÅLISIS TEMPORAL AVANZADO
CREATE INDEX idx_calls_temporal_analysis 
ON operator_call_data(fecha_hora_llamada, mission_id, numero_origen, numero_destino, duracion_segundos);

-- 4. CORRELACI√ìN GEOGR√ÅFICA
CREATE INDEX idx_calls_geographic_correlation 
ON operator_call_data(mission_id, celda_origen, celda_destino, fecha_hora_llamada);

-- 5. ESTAD√çSTICAS POR OPERADOR
CREATE INDEX idx_calls_operator_participants 
ON operator_call_data(operator, mission_id, numero_origen, numero_destino);
```

### **ESTRATEGIAS DE OPTIMIZACI√ìN**

1. **Query Bidireccional con UNION:** Evita m√∫ltiples consultas
2. **LEFT JOINs Condicionales:** Solo cuando se necesita correlaci√≥n HUNTER
3. **√çndices Compuestos:** Cubren consultas completas sin table scan
4. **Prepared Statements:** Reutilizaci√≥n de planes de ejecuci√≥n
5. **Paginaci√≥n Inteligente:** Para historiales extensos (>500 llamadas)

---

## üí° INTEGRACI√ìN CON FRONTEND REACT

### **ACTIVACI√ìN DESDE DIAGRAMA**

El frontend React Flow detectar√° clicks en enlaces del diagrama y llamar√°:

```javascript
// Desde componente React Flow
const handleLinkClick = async (linkData) => {
    const { numberA, numberB, missionId } = linkData;
    
    // Llamar nueva funci√≥n Eel
    const history = await window.eel.get_communication_history(
        missionId, 
        numberA, 
        numberB,
        { start: "2021-05-20 00:00:00", end: "2021-05-25 23:59:59" },
        { operators: ["CLARO"], min_duration: 10 }
    )();
    
    // Mostrar en modal o p√°gina dedicada
    showCommunicationHistoryModal(history);
};
```

### **COMPONENTES UI SUGERIDOS**

1. **`CommunicationHistoryModal`** - Modal principal con timeline
2. **`CallDetailPanel`** - Panel lateral con detalles t√©cnicos  
3. **`GeographicVisualization`** - Mapa con ubicaciones HUNTER
4. **`PatternAnalysisChart`** - Gr√°ficos de patrones temporales
5. **`StatisticsPanel`** - M√©tricas forenses resumidas

---

## üîí CONSIDERACIONES DE SEGURIDAD

### **VALIDACI√ìN DE ENTRADA**
- Sanitizaci√≥n de n√∫meros telef√≥nicos
- Validaci√≥n de rangos de fechas
- Verificaci√≥n de permisos por misi√≥n
- Prevenci√≥n de SQL injection (parametros preparados)

### **CONTROL DE ACCESO**
- Verificar que usuario tiene acceso a la misi√≥n espec√≠fica  
- Auditor√≠a de consultas sensibles
- Rate limiting para prevenir abuso
- Logs forenses para trazabilidad

### **PRIVACIDAD DE DATOS**
- Ofuscaci√≥n opcional de n√∫meros (seg√∫n configuraci√≥n)
- Exportaci√≥n controlada de resultados
- Cumplimiento con regulaciones locales

---

## üìà M√âTRICAS DE RENDIMIENTO ESPERADAS

### **CONSULTAS BASE (Sin Optimizaci√≥n)**
- Historial 100 llamadas: ~150ms
- Historial 1,000 llamadas: ~800ms  
- An√°lisis correlaci√≥n: ~2,500ms

### **CONSULTAS OPTIMIZADAS (Con √çndices Propuestos)**
- Historial 100 llamadas: ~45ms
- Historial 1,000 llamadas: ~180ms
- An√°lisis correlaci√≥n: ~450ms

### **MEJORA ESPERADA**
- **Reducci√≥n 70%** en tiempo de respuesta
- **Escalabilidad** para datasets grandes
- **Concurrencia** mejorada para m√∫ltiples usuarios

---

## üöÄ PLAN DE IMPLEMENTACI√ìN

### **FASE 1: Funciones Base (2-3 d√≠as)**
1. Implementar `get_communication_history`
2. Crear √≠ndices especializados
3. Testing b√°sico con datos existentes

### **FASE 2: An√°lisis Avanzado (2-3 d√≠as)**  
1. Implementar `get_call_details`
2. Implementar `get_related_communications`
3. Optimizar queries complejas

### **FASE 3: Integraci√≥n Frontend (1-2 d√≠as)**
1. Conectar con React Flow diagram
2. Crear componentes UI especializados
3. Testing de integraci√≥n completa

### **FASE 4: Optimizaci√≥n y Testing (1-2 d√≠as)**
1. Profiling de rendimiento
2. Testing de carga con datasets grandes
3. Documentaci√≥n final para usuarios

---

## üìù ARCHIVOS A CREAR/MODIFICAR

### **Backend Python:**
- `services/communication_history_service.py` (NUEVO)
- `main.py` (MODIFICAR - agregar funciones Eel)
- `database/migration_history_indexes.sql` (NUEVO)

### **Frontend React:**
- `components/ui/CommunicationHistoryModal.tsx` (NUEVO)
- `components/diagrams/NetworkDiagram.tsx` (MODIFICAR)
- `services/api.ts` (MODIFICAR - nuevos endpoints)

### **Base de Datos:**
- Script SQL para nuevos √≠ndices
- Testing de rendimiento pre/post optimizaci√≥n

---

## üéØ BENEFICIOS ESPERADOS

### **PARA INVESTIGADORES:**
- **Historial completo** entre n√∫meros espec√≠ficos
- **Correlaci√≥n geogr√°fica** autom√°tica con datos HUNTER
- **Patrones temporales** visualizados claramente
- **An√°lisis forense** con detalles t√©cnicos completos

### **PARA EL SISTEMA:**
- **Reutilizaci√≥n** de infraestructura existente
- **Escalabilidad** para datasets grandes
- **Mantenibilidad** con servicios modulares
- **Rendimiento** optimizado para investigaci√≥n en tiempo real

---

## ‚ö†Ô∏è CONSIDERACIONES CR√çTICAS

1. **No afectar funcionalidad existente** de correlaci√≥n
2. **Mantener compatibilidad** con estructura actual
3. **Optimizar para investigaci√≥n forense** (precisi√≥n > velocidad)
4. **Preparar para escalabilidad** futura (millones de registros)

---

**PR√ìXIMOS PASOS RECOMENDADOS:**

1. ‚úÖ Revisar y aprobar especificaciones
2. üîÑ Implementar `get_communication_history` como funci√≥n base
3. üîÑ Crear √≠ndices especializados de rendimiento
4. üîÑ Testing con datos reales de la misi√≥n actual
5. üîÑ Integraci√≥n con React Flow para activaci√≥n desde diagrama

**Boris, esta arquitectura leverages tu infraestructura existente mientras a√±ade las capacidades espec√≠ficas de historial que necesitas para el diagrama de correlaci√≥n. ¬øTe parece adecuado el enfoque o quieres que ajuste alg√∫n aspecto espec√≠fico?**